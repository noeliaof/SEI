---
title: "SEI: Standardised indices for the monitoring of energy droughts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,comment = "#>", fig.width = 10, fig.height = 5)
```


### Introduction

`SEI` is a package in R to calculate standardized energy indices that can be used to monitor **droughts** in renewable energy systems. The indices incorporate energy demand and renewable energy production, and constitute analogues of the standardised precipitation index (SPI) and standardised precipitation evapotranspiration index (SPEI), two indices that are regularly employed within operational hydro-meteorological drought monitoring systems. 

Now, install and load the `SEI` package and lets get started!


```{r setup, include=FALSE}
library(SEI)
library(dplyr)
```

### Metholody

The indices are straightforward to construct, can be defined on any timescale, and behave in a relative sense, meaning they can readily be compared for regions with different climates and different installed capacities.
The general approach to define standardised indices begins by estimating the cumulative distribution function (CDF) corresponding to these previously observed values, which we label $ F $. This could be done by assuming the renewable energy production and residual load observations have been drawn from a certain parametric family of statistical distributions: the SPI, for example, assumes precipitation follows a Gamma distribution \citep{McKee1993}, while the SPEI employs a log-logistic distribution for $ F $ \citep{Vicente2010}. The parameters of the chosen distribution could then be estimated from the previous observations, using maximum likelihood estimation, for example. 

### Use: Case study

The data used for the case study correspond to time series of renewable generation solar and wind for a total of 27 countries across Europe. This data is publicity available at the \url{https://researchdata.reading.ac.uk/275/}. The original data provides the capacity factors for solar and wind, which were later multiplied by the installed capacities (IC). In this case, we use the installed capacities of 2017.

Let's have a look at the IC.

```{r}
data("data_ic2017")
head(data_ic2017)
```

We can use either country abbreviations or codes to use in the plots. 

```{r}
abbrevs <- get_abbrevs(unique(data_ic2017$country))
s_names <- unlist(lapply(unique(data_ic2017$country), get_shortcountry_names))
```

```{r fig.align = 'center', out.width = '100%'}
plot_ics(data_ic2017, s_names)
```

### Indices calculation

#### Raw values

We begin by looking at the raw renewable energy production, in this case, "PWS", which is wind and solar production.
But it can be applied to any other energy indicator, such as, electricity demand or individual renewable energy sources.

```{r}
data("data_supply")
head(data_supply)
```

```{r}
nvars <- c("PWS") 
```


Let's calculate raw data (at hourly, daily, weekly and two-weekly scales):

```{r}
raw_1h <- calculate_energyindex_country(data_supply, method = "none", scale = NULL, nvars)
raw_1d <- calculate_energyindex_country(data_supply, method = "none", scale = 24, nvars)
```

```{r}
head(raw_1h$SDEI$Austria)
```
The outputs from this is a data frame that contains the time series of the index. We can visualize the values for one country. As an example we can plot the index for Portugal.

```{r}
country_str <- "Portugal"
variable_str <- "PWS"
year_vec <- 2019
```

We first plot the raw values:
```{r}
sdei_raw_reduced <- raw_1h$SDEI[[country_str]] %>% dplyr::filter(type == variable_str)
head(sdei_raw_reduced)
```
Visualize the time series:

```{r fig.width = 8, fig.height = 4}
library(ggplot2)
plot_sdei(sdei_raw_reduced, year_vec,ivar = "SDEI")
```

```{r fig.width = 8, fig.height = 4}
sdei_rawD_reduced <- raw_1d$SDEI[[country_str]] %>% dplyr::filter(type == variable_str)
plot_sdei(sdei_rawD_reduced, year_vec,ivar = "SDEI")
```

Note that the units are GW.

#### Standarised values

We can now calculate the standardised renewable energy production index (SREPI) at different time scales (e.g., hourly, daily, weekly etc ...)
Let's calculate the SREPI at hourly and daily time scales.

```{r}
sdei_1h <- calculate_energyindex_country(data_supply, method = "empirical", scale = NULL, nvars)
sdei_1d <- calculate_energyindex_country(data_supply, method = "empirical", scale = 24, nvars)
```


```{r fig.width = 8, fig.height = 4}
sdei_reduced <- sdei_1h$SDEI[[country_str]] %>% dplyr::filter(type == variable_str)
sdeiD_reduced <- sdei_1d$SDEI[[country_str]] %>% dplyr::filter(type == variable_str)
plot_sdei(sdei_reduced, year_vec, ivar = "SDEI")
plot_sdei(sdei_reduced, year_vec, ivar = "SDEI")
```

Note that the SREPI is dimensionless.


#### Distributions

Raw distribution:
```{r fig.width = 8, fig.height = 4}
ylabb <- if(variable_str == "res_load_WS"){"RL (GW)"}else if(variable_str == "PWS"){"REP (GW)"}else{""}
plot_sdei_dist(sdei_raw_reduced, n_bins = 50, title = ylabb)
```

Standarised distribution:

```{r fig.width = 8, fig.height = 4}
ylabb <- if(variable_str == "res_load_WS"){"SRLI"}else if(variable_str == "PWS"){"SREPI"}else{""}
plot_sdei_dist(sdei_reduced, n_bins = 50, title = ylabb)
```


